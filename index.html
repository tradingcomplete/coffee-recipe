<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ã‚³ãƒ¼ãƒ’ãƒ¼æŠ½å‡ºãƒ¬ã‚·ãƒ”</title>
    <style>
        :root {
            --primary-color: #6F4E37;
            --secondary-color: #3E2723;
            --accent-color: #8B4513;
            --step-bg: #FFF8DC;
            --step-border: #D2691E;
        }

        html {
            overflow-x: hidden;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            padding: 15px;
            color: #333;
            transition: background 0.6s ease;
            overflow-x: hidden;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 26px;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #555;
        }

        select, input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: #f8f8f8;
            transition: all 0.3s;
        }

        select option {
            font-size: 14px;
            padding: 8px;
            line-height: 1.4;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent-color);
            background: white;
        }

        .result {
            display: none;
        }

        .result.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .recipe-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f8f8;
            border-radius: 12px;
            border-left: 4px solid var(--accent-color);
        }

        .recipe-item.highlight {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--primary-color) 100%);
            color: white;
            font-weight: 600;
            border-left: none;
        }

        .recipe-label {
            font-size: 15px;
        }

        .recipe-value {
            font-size: 20px;
            font-weight: 700;
        }

        .steps {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #e0e0e0;
        }

        .step {
            margin-bottom: 12px;
            padding: 10px;
            background: var(--step-bg);
            border-radius: 10px;
            border-left: 4px solid var(--step-border);
        }

        .step-number {
            display: inline-block;
            width: 25px;
            height: 25px;
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 25px;
            font-weight: 700;
            margin-right: 10px;
        }

        .emoji {
            font-size: 20px;
            margin-right: 5px;
        }

        /* ã‚¿ã‚¤ãƒãƒ¼ç”»é¢ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .timer-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            z-index: 1000;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
        }

        .timer-screen.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .timer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 20px;
        }

        .back-button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        .timer-container {
            background: white;
            border-radius: 20px;
            padding: 15px;
            padding-bottom: 65px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
            min-height: auto;
        }

        .timer-display {
            font-size: 64px;
            font-weight: 700;
            color: var(--accent-color);
            margin: 10px 0;
            font-variant-numeric: tabular-nums;
            transition: all 0.3s;
        }

        .timer-display.warning {
            color: #FF6B6B;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .progress-ring {
            transform: rotate(-90deg);
            margin: 0;
            display: block;
            position: relative;
            left: 0;
            right: 0;
        }

        .progress-ring-wrapper {
            width: 160px;
            height: 160px;
            margin: 5px auto;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s;
            transform-origin: 50% 50%;
        }

        .current-step {
            font-size: 26px;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 8px;
        }

        .step-instruction {
            font-size: 22px;
            color: #666;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .timer-button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .timer-button:active {
            transform: scale(0.95);
        }

        .reset-button {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: #FF6B6B;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.3s;
        }

        .reset-button:active {
            transform: scale(0.95);
        }

        .next-step-info {
            background: #f8f8f8;
            padding: 12px 15px;
            border-radius: 10px;
            margin-top: 15px;
            margin-bottom: 45px;
            font-size: 18px;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 0 10px rgba(139, 69, 19, 0.2);
        }

        .next-step-info .amount {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent-color);
        }

        .step-instruction .amount {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent-color);
        }

        .start-timer-button {
            width: 100%;
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .start-timer-button:active {
            transform: scale(0.98);
        }

        .completion-screen {
            text-align: center;
            padding: 10px 20px;
        }

        .completion-icon {
            font-size: 50px;
            margin-bottom: 10px;
        }

        .completion-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>â˜• ã‚³ãƒ¼ãƒ’ãƒ¼ãƒ¬ã‚·ãƒ”è¨ˆç®—</h1>
            <p>ç„™ç…åº¦ã¨è±†ã®é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        </div>

        <div class="card">
            <div class="input-group">
                <label for="roast">ğŸ”¥ ç„™ç…åº¦</label>
                <select id="roast" onchange="calculate()">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    <option value="medium">ãƒŸãƒ‡ã‚£ã‚¢ãƒ &#10;ï¼ˆä¸­æµ…ç…ã‚Šï¼‰</option>
                    <option value="high">ãƒã‚¤&#10;ï¼ˆä¸­ç…ã‚Šï¼‰</option>
                    <option value="city">ã‚·ãƒ†ã‚£&#10;ï¼ˆä¸­æ·±ç…ã‚Šï¼‰</option>
                    <option value="fullcity">ãƒ•ãƒ«ã‚·ãƒ†ã‚£&#10;ï¼ˆæ·±ç…ã‚Šï¼‰</option>
                    <option value="french">ãƒ•ãƒ¬ãƒ³ãƒ&#10;ï¼ˆæ¥µæ·±ç…ã‚Šï¼‰</option>
                    <option value="italian">ã‚¤ã‚¿ãƒªã‚¢ãƒ³&#10;ï¼ˆæ¥µæ·±ç…ã‚Šï¼‰</option>
                </select>
            </div>

            <div class="input-group">
                <label for="beans">âš–ï¸ è±†ã®é‡ï¼ˆgï¼‰</label>
                <input type="number" id="beans" placeholder="ä¾‹: 14" min="1" max="100" oninput="calculate()">
            </div>
        </div>

        <div id="result" class="card result">
            <div class="recipe-item highlight">
                <span class="recipe-label"><span class="emoji">â˜•</span>æœ€çµ‚å‡ºæ¥ä¸ŠãŒã‚Š</span>
                <span class="recipe-value" id="final">0 g</span>
            </div>

            <div class="recipe-item">
                <span class="recipe-label">1æŠ•ç›®ï¼ˆè’¸ã‚‰ã—ï¼‰</span>
                <span class="recipe-value" id="pour1">0 g</span>
            </div>

            <div class="recipe-item">
                <span class="recipe-label">2æŠ•ç›®ã¾ã§</span>
                <span class="recipe-value" id="pour2">0 g</span>
            </div>

            <div class="recipe-item">
                <span class="recipe-label">3æŠ•ç›®ã¾ã§ï¼ˆæŠ½å‡ºå®Œäº†ï¼‰</span>
                <span class="recipe-value" id="pour3">0 g</span>
            </div>

            <div class="recipe-item">
                <span class="recipe-label">è¿½åŠ ã®ãŠæ¹¯</span>
                <span class="recipe-value" id="extra">0 g</span>
            </div>

            <div class="recipe-item">
                <span class="recipe-label">â±ï¸ æŠ½å‡ºæ™‚é–“</span>
                <span class="recipe-value" id="brewTime">0 åˆ†ä»¥å†…</span>
            </div>

            <div class="steps">
                <div class="step">
                    <span class="step-number">1</span>
                    <span id="step1">è±†ã‚’æŒ½ã„ã¦ã‚»ãƒƒãƒˆã™ã‚‹</span>
                </div>
                <div class="step">
                    <span class="step-number">2</span>
                    <span id="step2">1æŠ•ç›®ã®ãŠæ¹¯ã§è’¸ã‚‰ã™</span>
                </div>
                <div class="step">
                    <span class="step-number">3</span>
                    <span id="step3">45ç§’å¾Œã€2æŠ•ç›®ã‚’æ³¨ã</span>
                </div>
                <div class="step">
                    <span class="step-number">4</span>
                    <span id="step4">ã•ã‚‰ã«45ç§’å¾Œã€3æŠ•ç›®ã‚’æ³¨ã</span>
                </div>
                <div class="step">
                    <span class="step-number">5</span>
                    <span id="step5">45ç§’å¾Œã€ãŠæ¹¯ãŒè½ã¡ãã‚‹ã¾ã§å¾…ã¤</span>
                </div>
                <div class="step">
                    <span class="step-number">6</span>
                    <span id="step6">è¿½åŠ ã®ãŠæ¹¯ã‚’æ³¨ã„ã§å®Œæˆ</span>
                </div>
            </div>

            <button class="start-timer-button" onclick="startTimerMode()">
                â±ï¸ ã‚¿ã‚¤ãƒãƒ¼æŠ½å‡ºã‚’é–‹å§‹
            </button>
        </div>

        <!-- ã‚¿ã‚¤ãƒãƒ¼ç”»é¢ -->
        <div id="timerScreen" class="timer-screen">
            <div class="timer-header">
                <button class="back-button" onclick="exitTimer()">â† æˆ»ã‚‹</button>
                <h2 style="margin: 0;">ã‚¿ã‚¤ãƒãƒ¼æŠ½å‡º</h2>
                <div style="width: 60px;"></div>
            </div>

            <div class="timer-container">
                <button class="reset-button" id="resetButton" onclick="resetTimer()" style="display: none;">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>

                <div class="current-step" id="timerStepTitle">æº–å‚™</div>
                <div class="step-instruction" id="timerStepInstruction">è±†ã‚’æŒ½ã„ã¦ã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„</div>

                <div style="background: #f0f0f0; padding: 12px; border-radius: 10px; margin-bottom: 15px;">
                    <div style="font-size: 18px; color: #666;">ç·æŠ½å‡ºæ™‚é–“</div>
                    <div style="font-size: 42px; font-weight: 700; color: var(--accent-color);" id="totalTime">0:00</div>
                </div>

                <div class="progress-ring-wrapper">
                    <svg class="progress-ring" width="160" height="160" id="progressRing">
                    <circle
                        stroke="#e0e0e0"
                        stroke-width="10"
                        fill="transparent"
                        r="70"
                        cx="80"
                        cy="80"
                    />
                    <circle
                        class="progress-ring-circle"
                        stroke="var(--accent-color)"
                        stroke-width="10"
                        fill="transparent"
                        r="70"
                        cx="80"
                        cy="80"
                        id="progressCircle"
                        style="stroke-dasharray: 439.82; stroke-dashoffset: 0;"
                    />
                </svg>
                </div>

                <div class="timer-display" id="timerDisplay">--:--</div>

                <div id="timerControls" class="timer-controls">
                    <button class="timer-button" onclick="startTimer()">é–‹å§‹</button>
                </div>

                <div class="next-step-info" id="nextStepInfo" style="display: none;">
                    <strong>æ¬¡ã®æ‰‹é †ï¼š</strong><br>
                    <span id="nextStepText"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç„™ç…åº¦ã”ã¨ã®è¨­å®š
        const roastConfig = {
            medium: {
                name: 'ãƒŸãƒ‡ã‚£ã‚¢ãƒ ',
                ratio: 16.6,
                extractRatio: 16.6,
                brewTime: 3,
                pour1Ratio: 2.5,
                pour2Ratio: 10,
                pour3Ratio: 16.6,
                stepDuration: 45, // å„æŠ•ç›®ã®ç§’æ•°
                colors: {
                    primary: '#C19A6B',
                    secondary: '#A0826D',
                    accent: '#D2B48C',
                    stepBg: '#FFF8DC',
                    stepBorder: '#DEB887'
                }
            },
            high: {
                name: 'ãƒã‚¤',
                ratio: 16.6,
                extractRatio: 14,
                brewTime: 3,
                pour1Ratio: 2.5,
                pour2Ratio: 8.5,
                pour3Ratio: 14,
                stepDuration: 45, // å„æŠ•ç›®ã®ç§’æ•°
                colors: {
                    primary: '#A0826D',
                    secondary: '#8B7355',
                    accent: '#BC8F8F',
                    stepBg: '#FFF5EE',
                    stepBorder: '#D2691E'
                }
            },
            city: {
                name: 'ã‚·ãƒ†ã‚£',
                ratio: 16.6,
                extractRatio: 12,
                brewTime: 3,
                pour1Ratio: 2.5,
                pour2Ratio: 7,
                pour3Ratio: 12,
                stepDuration: 30, // å„æŠ•ç›®ã®ç§’æ•°
                colors: {
                    primary: '#8B4513',
                    secondary: '#654321',
                    accent: '#A0522D',
                    stepBg: '#FFF0E5',
                    stepBorder: '#CD853F'
                }
            },
            fullcity: {
                name: 'ãƒ•ãƒ«ã‚·ãƒ†ã‚£',
                ratio: 16.6,
                extractRatio: 10,
                brewTime: 3,
                pour1Ratio: 2.1,
                pour2Ratio: 5.7,
                pour3Ratio: 10,
                stepDuration: 30, // å„æŠ•ç›®ã®ç§’æ•°
                colors: {
                    primary: '#6F4E37',
                    secondary: '#583822',
                    accent: '#8B4513',
                    stepBg: '#FAEBD7',
                    stepBorder: '#A0522D'
                }
            },
            french: {
                name: 'ãƒ•ãƒ¬ãƒ³ãƒ',
                ratio: 16.6,
                extractRatio: 9,
                brewTime: 3,
                pour1Ratio: 2.1,
                pour2Ratio: 5.7,
                pour3Ratio: 9,
                stepDuration: 30, // å„æŠ•ç›®ã®ç§’æ•°
                colors: {
                    primary: '#4A3728',
                    secondary: '#2F2419',
                    accent: '#6F4E37',
                    stepBg: '#F5DEB3',
                    stepBorder: '#8B4513'
                }
            },
            italian: {
                name: 'ã‚¤ã‚¿ãƒªã‚¢ãƒ³',
                ratio: 16.6,
                extractRatio: 8,
                brewTime: 3,
                pour1Ratio: 2.1,
                pour2Ratio: 4.8,
                pour3Ratio: 8,
                stepDuration: 30, // å„æŠ•ç›®ã®ç§’æ•°
                colors: {
                    primary: '#3E2723',
                    secondary: '#1C0F0D',
                    accent: '#4A3728',
                    stepBg: '#E8D5C4',
                    stepBorder: '#6F4E37'
                }
            }
        };

        // 5gå˜ä½ã«åˆ‡ã‚Šä¸‹ã’ã‚‹é–¢æ•°
        function roundToNearest5(value) {
            return Math.floor(value / 5) * 5;
        }

        // ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’å¤‰æ›´ã™ã‚‹é–¢æ•°
        function changeTheme(colors) {
            const root = document.documentElement;
            root.style.setProperty('--primary-color', colors.primary);
            root.style.setProperty('--secondary-color', colors.secondary);
            root.style.setProperty('--accent-color', colors.accent);
            root.style.setProperty('--step-bg', colors.stepBg);
            root.style.setProperty('--step-border', colors.stepBorder);
        }

        function calculate() {
            const roastSelect = document.getElementById('roast');
            const beansInput = document.getElementById('beans');
            const resultDiv = document.getElementById('result');

            const roast = roastSelect.value;
            const beans = parseFloat(beansInput.value);

            // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (!roast || !beans || beans <= 0) {
                resultDiv.classList.remove('show');
                return;
            }

            const config = roastConfig[roast];

            // ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’å¤‰æ›´
            changeTheme(config.colors);

            // è¨ˆç®—ï¼ˆ5gå˜ä½ã«ä¸¸ã‚ã‚‹ï¼‰
            const finalAmount = roundToNearest5(beans * config.ratio);
            const pour1 = roundToNearest5(beans * config.pour1Ratio);
            const pour2 = roundToNearest5(beans * config.pour2Ratio);
            const pour3 = roundToNearest5(beans * config.pour3Ratio);
            const extraWater = finalAmount - pour3;

            // çµæœè¡¨ç¤º
            document.getElementById('final').textContent = finalAmount + ' g';
            document.getElementById('pour1').textContent = pour1 + ' g';
            document.getElementById('pour2').textContent = pour2 + ' g';
            document.getElementById('pour3').textContent = pour3 + ' g';
            document.getElementById('extra').textContent = extraWater + ' g';
            document.getElementById('brewTime').textContent = config.brewTime + ' åˆ†ä»¥å†…';

            // ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–°
            const stepSec = config.stepDuration;
            document.getElementById('step1').textContent = `${beans}gã®è±†ã‚’æŒ½ã„ã¦ã‚»ãƒƒãƒˆã™ã‚‹`;
            document.getElementById('step2').textContent = `${pour1}gã®ãŠæ¹¯ã‚’æ³¨ãï¼ˆè’¸ã‚‰ã—é–‹å§‹ï¼‰`;
            document.getElementById('step3').textContent = `${stepSec}ç§’å¾Œã€åˆè¨ˆ${pour2}gã¾ã§ãŠæ¹¯ã‚’æ³¨ã`;
            document.getElementById('step4').textContent = `ã•ã‚‰ã«${stepSec}ç§’å¾Œã€åˆè¨ˆ${pour3}gã¾ã§ãŠæ¹¯ã‚’æ³¨ã`;
            document.getElementById('step5').textContent = `${stepSec}ç§’å¾Œã€ãŠæ¹¯ãŒè½ã¡ãã‚‹ã¾ã§å¾…ã¤`;
            document.getElementById('step6').textContent = extraWater > 0 
                ? `${extraWater}gã®ãŠæ¹¯ã‚’è¿½åŠ ã—ã¦å®Œæˆï¼ˆåˆè¨ˆ${finalAmount}gï¼‰`
                : `å®Œæˆï¼ˆ${finalAmount}gï¼‰`;

            // çµæœã‚’è¡¨ç¤º
            resultDiv.classList.add('show');
        }

        // ã‚¿ã‚¤ãƒãƒ¼é–¢é€£ã®å¤‰æ•°
        let currentRecipe = null;
        let currentStep = 0;
        let timerInterval = null;
        let totalTimeInterval = null;
        let timeLeft = 0;
        let totalTimeElapsed = 0;
        let audioContext = null;
        let beepAudioElement = null;
        let completionAudioElement = null;
        let useAudioElements = false; // ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã¯trueã«

        // ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’åˆ¤å®š
        function isStandalone() {
            return window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
        }

        // éŸ³å£°è¦ç´ ã‚’æº–å‚™
        function prepareAudioElements() {
            // ãƒ“ãƒ¼ãƒ—éŸ³ç”¨ã®audioè¦ç´ ã‚’å‹•çš„ã«ä½œæˆ
            if (!beepAudioElement) {
                beepAudioElement = new Audio();
                // çŸ­ã„ãƒ“ãƒ¼ãƒ—éŸ³ã‚’WAVãƒ‡ãƒ¼ã‚¿ã§ä½œæˆï¼ˆ1000Hz, 0.1ç§’ï¼‰
                const sampleRate = 44100;
                const duration = 0.1;
                const frequency = 1000;
                const numSamples = Math.floor(sampleRate * duration);
                
                const wavData = generateBeepWav(sampleRate, frequency, duration, numSamples);
                const blob = new Blob([wavData], { type: 'audio/wav' });
                beepAudioElement.src = URL.createObjectURL(blob);
                beepAudioElement.load();
            }
            
            // å®Œäº†éŸ³ç”¨ï¼ˆ3ã¤ã®éŸ³ã‚’é€£ç¶šã§ï¼‰
            if (!completionAudioElement) {
                completionAudioElement = new Audio();
                const sampleRate = 44100;
                const duration = 0.65;
                const numSamples = Math.floor(sampleRate * duration);
                
                const wavData = generateCompletionWav(sampleRate, duration, numSamples);
                const blob = new Blob([wavData], { type: 'audio/wav' });
                completionAudioElement.src = URL.createObjectURL(blob);
                completionAudioElement.load();
            }
        }

        // ãƒ“ãƒ¼ãƒ—éŸ³ã®WAVãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
        function generateBeepWav(sampleRate, frequency, duration, numSamples) {
            const dataLength = numSamples * 2; // 16-bit
            const bufferLength = 44 + dataLength;
            const arrayBuffer = new ArrayBuffer(bufferLength);
            const view = new DataView(arrayBuffer);
            
            // WAVãƒ˜ãƒƒãƒ€ãƒ¼
            writeWavHeader(view, sampleRate, dataLength);
            
            // éŸ³å£°ãƒ‡ãƒ¼ã‚¿
            let offset = 44;
            for (let i = 0; i < numSamples; i++) {
                const t = i / sampleRate;
                const sample = Math.sin(2 * Math.PI * frequency * t) * 0.3;
                const intSample = Math.max(-1, Math.min(1, sample));
                view.setInt16(offset, intSample < 0 ? intSample * 0x8000 : intSample * 0x7FFF, true);
                offset += 2;
            }
            
            return arrayBuffer;
        }

        // å®Œäº†éŸ³ã®WAVãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
        function generateCompletionWav(sampleRate, duration, numSamples) {
            const dataLength = numSamples * 2;
            const bufferLength = 44 + dataLength;
            const arrayBuffer = new ArrayBuffer(bufferLength);
            const view = new DataView(arrayBuffer);
            
            // WAVãƒ˜ãƒƒãƒ€ãƒ¼
            writeWavHeader(view, sampleRate, dataLength);
            
            // 3éŸ³ã®ãƒ¡ãƒ­ãƒ‡ã‚£ï¼ˆC5, E5, G5ï¼‰
            const notes = [523.25, 659.25, 783.99];
            const noteDuration = 0.2;
            const noteSamples = Math.floor(sampleRate * noteDuration);
            
            let offset = 44;
            for (let i = 0; i < numSamples; i++) {
                let sample = 0;
                const noteIndex = Math.floor(i / (sampleRate * 0.2));
                
                if (noteIndex < notes.length) {
                    const t = (i % (sampleRate * 0.2)) / sampleRate;
                    const envelope = Math.exp(-t * 5);
                    sample = Math.sin(2 * Math.PI * notes[noteIndex] * t) * 0.3 * envelope;
                }
                
                const intSample = Math.max(-1, Math.min(1, sample));
                view.setInt16(offset, intSample < 0 ? intSample * 0x8000 : intSample * 0x7FFF, true);
                offset += 2;
            }
            
            return arrayBuffer;
        }

        // WAVãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ›¸ãè¾¼ã‚€
        function writeWavHeader(view, sampleRate, dataLength) {
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM
            view.setUint16(22, 1, true); // ãƒ¢ãƒãƒ©ãƒ«
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); // ãƒã‚¤ãƒˆãƒ¬ãƒ¼ãƒˆ
            view.setUint16(32, 2, true); // ãƒ–ãƒ­ãƒƒã‚¯ã‚¢ãƒ©ã‚¤ãƒ³
            view.setUint16(34, 16, true); // ãƒ“ãƒƒãƒˆæ·±åº¦
            writeString(36, 'data');
            view.setUint32(40, dataLength, true);
        }

        // éŸ³å£°ã‚’åˆæœŸåŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å¾Œã«å‘¼ã°ã‚Œã‚‹ï¼‰
        function initAudio() {
            // ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯audioè¦ç´ ã‚’ä½¿ç”¨
            if (isStandalone()) {
                useAudioElements = true;
                try {
                    prepareAudioElements();
                    console.log('Audio elements prepared for standalone mode');
                } catch (e) {
                    console.error('Failed to prepare audio elements:', e);
                }
            } else {
                // ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¢ãƒ¼ãƒ‰ã§ã¯Web Audio APIã‚’ä½¿ç”¨
                if (!audioContext) {
                    try {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        // iOSã®ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ãƒ¢ãƒ¼ãƒ‰å¯¾ç­–: resumeã‚’æ˜ç¤ºçš„ã«å‘¼ã¶
                        if (audioContext.state === 'suspended') {
                            audioContext.resume();
                        }
                        console.log('AudioContext initialized:', audioContext.state);
                    } catch (e) {
                        console.error('Failed to initialize AudioContext:', e);
                    }
                } else if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
            }
        }

        // ã‚¿ã‚¤ãƒãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹
        function startTimerMode() {
            const roastSelect = document.getElementById('roast');
            const beansInput = document.getElementById('beans');
            const roast = roastSelect.value;
            const beans = parseFloat(beansInput.value);

            if (!roast || !beans || beans <= 0) {
                alert('ç„™ç…åº¦ã¨è±†ã®é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // ã‚¿ã‚¤ãƒãƒ¼ç”»é¢ã‚’é–‹ãéš›ã«ã‚‚AudioContextã‚’åˆæœŸåŒ–ï¼ˆã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ãƒ¢ãƒ¼ãƒ‰å¯¾ç­–ï¼‰
            initAudio();

            const config = roastConfig[roast];
            const finalAmount = roundToNearest5(beans * config.ratio);
            const pour1 = roundToNearest5(beans * config.pour1Ratio);
            const pour2 = roundToNearest5(beans * config.pour2Ratio);
            const pour3 = roundToNearest5(beans * config.pour3Ratio);
            const extraWater = finalAmount - pour3;

            currentRecipe = {
                beans: beans,
                roast: config.name,
                extraWater: extraWater,
                steps: [
                    {
                        title: 'æº–å‚™',
                        instruction: `<span class="amount">${beans}g</span>ã®è±†ã‚’æŒ½ã„ã¦ã‚»ãƒƒãƒˆ`,
                        duration: 0,
                        action: ''
                    },
                    {
                        title: '1æŠ•ç›®ï¼ˆè’¸ã‚‰ã—ï¼‰',
                        instruction: `<span class="amount">${pour1}g</span>ã®ãŠæ¹¯ã‚’æ³¨ã`,
                        duration: config.stepDuration,
                        action: `<span class="amount">${pour1}g</span>æ³¨ã`
                    },
                    {
                        title: '2æŠ•ç›®',
                        instruction: `åˆè¨ˆ<span class="amount">${pour2}g</span>ã¾ã§ãŠæ¹¯ã‚’æ³¨ã`,
                        duration: config.stepDuration,
                        action: `åˆè¨ˆ<span class="amount">${pour2}g</span>ã¾ã§`
                    },
                    {
                        title: '3æŠ•ç›®ï¼ˆæŠ½å‡ºä¸­ï¼‰',
                        instruction: `åˆè¨ˆ<span class="amount">${pour3}g</span>ã¾ã§ãŠæ¹¯ã‚’æ³¨ã`,
                        duration: config.stepDuration,
                        action: `åˆè¨ˆ<span class="amount">${pour3}g</span>ã¾ã§`
                    },
                    {
                        title: 'ãŠæ¹¯ãŒè½ã¡ãã‚‹ã¾ã§å¾…ã¤',
                        instruction: '',
                        duration: 0,
                        isWaiting: true, // å¾…æ©Ÿã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ•ãƒ©ã‚°
                        action: 'è½ã¡ãã‚Šå¾…ã¡'
                    },
                    {
                        title: 'è¿½åŠ ã®ãŠæ¹¯',
                        instruction: extraWater > 0 ? `<span class="amount">${extraWater}g</span>ã®ãŠæ¹¯ã‚’è¿½åŠ ` : 'ãã®ã¾ã¾å®Œæˆã§ã™ï¼',
                        duration: 0,
                        action: extraWater > 0 ? `<span class="amount">${extraWater}g</span>è¿½åŠ ` : 'å®Œæˆ'
                    }
                ]
            };

            currentStep = 0;
            totalTimeElapsed = 0;
            document.getElementById('timerScreen').classList.add('active');
            document.getElementById('totalTime').textContent = '0:00';
            
            // ç·æŠ½å‡ºæ™‚é–“ã®ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤º
            const totalTimeBox = document.querySelector('#totalTime').parentElement;
            if (totalTimeBox) {
                totalTimeBox.style.display = 'block';
            }
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªãƒ³ã‚°wrapperã‚’è¡¨ç¤º
            const progressRingWrapper = document.querySelector('.progress-ring-wrapper');
            if (progressRingWrapper) {
                progressRingWrapper.style.display = 'flex';
            }
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªãƒ³ã‚°ã‚’åˆæœŸåŒ–
            const progressRing = document.getElementById('progressRing');
            progressRing.innerHTML = `
                <circle
                    stroke="#e0e0e0"
                    stroke-width="10"
                    fill="transparent"
                    r="70"
                    cx="80"
                    cy="80"
                />
                <circle
                    class="progress-ring-circle"
                    stroke="var(--accent-color)"
                    stroke-width="10"
                    fill="transparent"
                    r="70"
                    cx="80"
                    cy="80"
                    id="progressCircle"
                    style="stroke-dasharray: 439.82; stroke-dashoffset: 0;"
                />
            `;
            
            updateTimerDisplay();
        }

        // ã‚¿ã‚¤ãƒãƒ¼ç”»é¢ã‚’é–‰ã˜ã‚‹
        function exitTimer() {
            if (timerInterval) {
                if (!confirm('æŠ½å‡ºã‚’ä¸­æ­¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                    return;
                }
                clearInterval(timerInterval);
                timerInterval = null;
            }
            if (totalTimeInterval) {
                clearInterval(totalTimeInterval);
                totalTimeInterval = null;
            }
            
            // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            document.getElementById('resetButton').style.display = 'none';
            
            document.getElementById('timerScreen').classList.remove('active');
            currentStep = 0;
            currentRecipe = null;
            totalTimeElapsed = 0;
        }

        // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
        function updateTimerDisplay() {
            const step = currentRecipe.steps[currentStep];
            document.getElementById('timerStepTitle').textContent = step.title;
            document.getElementById('timerStepInstruction').innerHTML = step.instruction;

            if (step.duration > 0) {
                // duration ãŒã‚ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€ç·æ™‚é–“ã®ç‹¬ç«‹ã‚«ã‚¦ãƒ³ãƒˆã‚’åœæ­¢
                if (totalTimeInterval) {
                    clearInterval(totalTimeInterval);
                    totalTimeInterval = null;
                }
                
                timeLeft = step.duration;
                document.getElementById('timerDisplay').textContent = formatTime(timeLeft);
                
                // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—æƒ…å ±ã‚’è¡¨ç¤º
                if (currentStep < currentRecipe.steps.length - 1) {
                    const nextStep = currentRecipe.steps[currentStep + 1];
                    document.getElementById('nextStepText').innerHTML = nextStep.action;
                    document.getElementById('nextStepInfo').style.display = 'block';
                } else {
                    document.getElementById('nextStepInfo').style.display = 'none';
                }
            } else {
                // duration ãŒ 0 ã®ã‚¹ãƒ†ãƒƒãƒ—
                
                // å¾…æ©Ÿã‚¹ãƒ†ãƒƒãƒ—ã®å ´åˆã¯ç·æ™‚é–“ã‚’é€²ã‚ã‚‹
                if (step.isWaiting) {
                    if (!totalTimeInterval) {
                        totalTimeInterval = setInterval(() => {
                            totalTimeElapsed++;
                            document.getElementById('totalTime').textContent = formatTime(totalTimeElapsed);
                        }, 1000);
                    }
                    
                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªãƒ³ã‚°ã‚’éè¡¨ç¤º
                    const progressRingWrapper = document.querySelector('.progress-ring-wrapper');
                    if (progressRingWrapper) {
                        progressRingWrapper.style.display = 'none';
                    }
                    
                    document.getElementById('timerDisplay').textContent = 'å¾…æ©Ÿä¸­';
                    document.getElementById('timerControls').innerHTML = 
                        '<button class="timer-button" onclick="completeWaiting()">è½ã¡ãã£ãŸ</button>';
                    
                    // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—æƒ…å ±ã‚’è¡¨ç¤º
                    if (currentStep < currentRecipe.steps.length - 1) {
                        const nextStepData = currentRecipe.steps[currentStep + 1];
                        document.getElementById('nextStepText').innerHTML = nextStepData.action;
                        document.getElementById('nextStepInfo').style.display = 'block';
                    } else {
                        document.getElementById('nextStepInfo').style.display = 'none';
                    }
                } else if (currentStep > 0 && !totalTimeInterval) {
                    // å¾…æ©Ÿã‚¹ãƒ†ãƒƒãƒ—ä»¥å¤–ã®duration 0ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ç·æ™‚é–“ã ã‘é€²ã‚ã‚‹
                    totalTimeInterval = setInterval(() => {
                        totalTimeElapsed++;
                        document.getElementById('totalTime').textContent = formatTime(totalTimeElapsed);
                    }, 1000);
                    
                    // duration ãŒ 0 ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªãƒ³ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                    const progressRing = document.getElementById('progressRing');
                    if (progressRing) {
                        const circleElement = document.getElementById('progressCircle');
                        if (circleElement) {
                            const circumference = 2 * Math.PI * 70;
                            circleElement.style.strokeDashoffset = circumference; // å®Œå…¨ã«ç©ºã«ã™ã‚‹
                        }
                    }
                    
                    document.getElementById('timerDisplay').textContent = currentStep === 0 ? 'æº–å‚™å®Œäº†' : 'æº–å‚™å®Œäº†';
                    if (currentStep === currentRecipe.steps.length - 1) {
                        // æœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—
                        showCompletion();
                    } else if (currentStep === 0) {
                        // æœ€åˆã®æº–å‚™ã‚¹ãƒ†ãƒƒãƒ—
                        document.getElementById('timerControls').innerHTML = 
                            '<button class="timer-button" onclick="startBrewingProcess()">é–‹å§‹</button>';
                        if (currentStep < currentRecipe.steps.length - 1) {
                            const nextStepData = currentRecipe.steps[currentStep + 1];
                            document.getElementById('nextStepText').innerHTML = nextStepData.action;
                            document.getElementById('nextStepInfo').style.display = 'block';
                        }
                    } else {
                        // duration ãŒ 0 ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆè¿½åŠ ã®ãŠæ¹¯ãªã©ï¼‰
                        document.getElementById('timerControls').innerHTML = 
                            '<button class="timer-button" onclick="nextStep()">æ¬¡ã¸</button>';
                        if (currentStep < currentRecipe.steps.length - 1) {
                            const nextStepData = currentRecipe.steps[currentStep + 1];
                            document.getElementById('nextStepText').innerHTML = nextStepData.action;
                            document.getElementById('nextStepInfo').style.display = 'block';
                        }
                    }
                } else {
                    // currentStep === 0ã®å ´åˆ
                    // duration ãŒ 0 ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªãƒ³ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                    const progressRing = document.getElementById('progressRing');
                    if (progressRing) {
                        const circleElement = document.getElementById('progressCircle');
                        if (circleElement) {
                            const circumference = 2 * Math.PI * 70;
                            circleElement.style.strokeDashoffset = circumference;
                        }
                    }
                    
                    document.getElementById('timerDisplay').textContent = 'æº–å‚™å®Œäº†';
                    if (currentStep === currentRecipe.steps.length - 1) {
                        showCompletion();
                    } else if (currentStep === 0) {
                        document.getElementById('timerControls').innerHTML = 
                            '<button class="timer-button" onclick="startBrewingProcess()">é–‹å§‹</button>';
                        if (currentStep < currentRecipe.steps.length - 1) {
                            const nextStepData = currentRecipe.steps[currentStep + 1];
                            document.getElementById('nextStepText').innerHTML = nextStepData.action;
                            document.getElementById('nextStepInfo').style.display = 'block';
                        }
                    } else {
                        document.getElementById('timerControls').innerHTML = 
                            '<button class="timer-button" onclick="nextStep()">æ¬¡ã¸</button>';
                        if (currentStep < currentRecipe.steps.length - 1) {
                            const nextStepData = currentRecipe.steps[currentStep + 1];
                            document.getElementById('nextStepText').innerHTML = nextStepData.action;
                            document.getElementById('nextStepInfo').style.display = 'block';
                        }
                    }
                }
            }
        }

        // æŠ½å‡ºãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹å§‹ï¼ˆæº–å‚™ã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰ï¼‰
        function startBrewingProcess() {
            // éŸ³å£°ã‚’åˆæœŸåŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ãƒƒãƒ—æ™‚ã«åˆæœŸåŒ–ã™ã‚‹ã“ã¨ã§iPhoneã§ã‚‚å‹•ä½œï¼‰
            initAudio();
            
            // ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ãƒ¢ãƒ¼ãƒ‰å¯¾ç­–: å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦resume
            setTimeout(() => {
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume();
                }
            }, 100);
            
            // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('resetButton').style.display = 'block';
            
            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã¿ã€è‡ªå‹•çš„ã«ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            nextStep();
        }

        // ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
        function resetTimer() {
            // ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ç¢ºå®Ÿã«åœæ­¢
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            if (totalTimeInterval) {
                clearInterval(totalTimeInterval);
                totalTimeInterval = null;
            }
            
            // çŠ¶æ…‹ã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆ
            currentStep = 0;
            totalTimeElapsed = 0;
            timeLeft = 0;
            
            // è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('totalTime').textContent = '0:00';
            document.getElementById('timerDisplay').textContent = 'æº–å‚™å®Œäº†';
            document.getElementById('timerDisplay').classList.remove('warning');
            
            // ç·æŠ½å‡ºæ™‚é–“ã®ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤º
            const totalTimeBox = document.querySelector('#totalTime').parentElement;
            if (totalTimeBox) {
                totalTimeBox.style.display = 'block';
            }
            
            // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            document.getElementById('resetButton').style.display = 'none';
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªãƒ³ã‚°wrapperã‚’è¡¨ç¤º
            const progressRingWrapper = document.querySelector('.progress-ring-wrapper');
            if (progressRingWrapper) {
                progressRingWrapper.style.display = 'flex';
            }
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªãƒ³ã‚°ã‚’å®Œå…¨ã«å†åˆæœŸåŒ–
            const progressRing = document.getElementById('progressRing');
            if (progressRing) {
                progressRing.innerHTML = `
                    <circle
                        stroke="#e0e0e0"
                        stroke-width="10"
                        fill="transparent"
                        r="70"
                        cx="80"
                        cy="80"
                    />
                    <circle
                        class="progress-ring-circle"
                        stroke="var(--accent-color)"
                        stroke-width="10"
                        fill="transparent"
                        r="70"
                        cx="80"
                        cy="80"
                        id="progressCircle"
                        style="stroke-dasharray: 439.82; stroke-dashoffset: 439.82;"
                    />
                `;
            }
            
            // currentRecipeãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ã€æº–å‚™ã‚¹ãƒ†ãƒƒãƒ—ã®å†…å®¹ã‚’è¡¨ç¤º
            if (currentRecipe && currentRecipe.steps && currentRecipe.steps.length > 0) {
                const step = currentRecipe.steps[0];
                document.getElementById('timerStepTitle').textContent = step.title;
                document.getElementById('timerStepInstruction').textContent = step.instruction;
                
                // é–‹å§‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                document.getElementById('timerControls').innerHTML = 
                    '<button class="timer-button" onclick="startBrewingProcess()">é–‹å§‹</button>';
                
                // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—æƒ…å ±ã‚’è¡¨ç¤º
                if (currentRecipe.steps.length > 1) {
                    const nextStepData = currentRecipe.steps[1];
                    document.getElementById('nextStepText').innerHTML = nextStepData.action;
                    document.getElementById('nextStepInfo').style.display = 'block';
                } else {
                    document.getElementById('nextStepInfo').style.display = 'none';
                }
            } else {
                // currentRecipeãŒãªã„å ´åˆï¼ˆå¿µã®ãŸã‚ï¼‰
                document.getElementById('timerStepTitle').textContent = 'æº–å‚™';
                document.getElementById('timerStepInstruction').textContent = 'è±†ã‚’æŒ½ã„ã¦ã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„';
                document.getElementById('timerControls').innerHTML = 
                    '<button class="timer-button" onclick="startBrewingProcess()">é–‹å§‹</button>';
                document.getElementById('nextStepInfo').style.display = 'none';
            }
        }

        // æ™‚é–“ã‚’åˆ†:ç§’å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
        function startTimer() {
            const step = currentRecipe.steps[currentStep];
            timeLeft = step.duration;
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªãƒ³ã‚°wrapperã‚’ç¢ºå®Ÿã«è¡¨ç¤º
            const progressRingWrapper = document.querySelector('.progress-ring-wrapper');
            if (progressRingWrapper) {
                progressRingWrapper.style.display = 'flex';
            }
            
            const progressRing = document.getElementById('progressRing');
            const circle = document.getElementById('progressCircle');
            if (!circle) {
                // å††ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å†ä½œæˆ
                progressRing.innerHTML = `
                    <circle
                        stroke="#e0e0e0"
                        stroke-width="10"
                        fill="transparent"
                        r="70"
                        cx="80"
                        cy="80"
                    />
                    <circle
                        class="progress-ring-circle"
                        stroke="var(--accent-color)"
                        stroke-width="10"
                        fill="transparent"
                        r="70"
                        cx="80"
                        cy="80"
                        id="progressCircle"
                        style="stroke-dasharray: 439.82; stroke-dashoffset: 0;"
                    />
                `;
            }
            
            const circleElement = document.getElementById('progressCircle');
            const circumference = 2 * Math.PI * 70;
            circleElement.style.strokeDasharray = circumference;
            circleElement.style.strokeDashoffset = 0;

            document.getElementById('timerControls').innerHTML = 
                '<button class="timer-button" onclick="skipStep()">ã‚¹ã‚­ãƒƒãƒ—</button>';

            timerInterval = setInterval(() => {
                // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã¨ç·æ™‚é–“ã‚’åŒæ™‚ã«æ›´æ–°ï¼ˆåŒæœŸï¼‰
                timeLeft--;
                totalTimeElapsed++;
                document.getElementById('totalTime').textContent = formatTime(totalTimeElapsed);
                
                const progress = (step.duration - timeLeft) / step.duration;
                const offset = circumference * (1 - progress);
                circleElement.style.strokeDashoffset = offset;

                document.getElementById('timerDisplay').textContent = formatTime(timeLeft);

                // 5ç§’å‰ã‹ã‚‰ãƒ“ãƒ¼ãƒ—éŸ³ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                if (timeLeft <= 5 && timeLeft > 0) {
                    document.getElementById('timerDisplay').classList.add('warning');
                    playBeep();
                } else {
                    document.getElementById('timerDisplay').classList.remove('warning');
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    playCompletionSound();
                    setTimeout(() => {
                        nextStep();
                    }, 500);
                }
            }, 1000);
        }

        // å¾…æ©Ÿå®Œäº†ï¼ˆè½ã¡ãã£ãŸï¼‰
        function completeWaiting() {
            // ç·æ™‚é–“ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’åœæ­¢
            if (totalTimeInterval) {
                clearInterval(totalTimeInterval);
                totalTimeInterval = null;
            }
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªãƒ³ã‚°wrapperã‚’å†è¡¨ç¤º
            const progressRingWrapper = document.querySelector('.progress-ring-wrapper');
            if (progressRingWrapper) {
                progressRingWrapper.style.display = 'flex';
            }
            
            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
            nextStep();
        }

        // ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—
        function skipStep() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('timerDisplay').classList.remove('warning');
            nextStep();
        }

        // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
        function nextStep() {
            document.getElementById('timerDisplay').classList.remove('warning');
            currentStep++;
            if (currentStep < currentRecipe.steps.length) {
                updateTimerDisplay();
                
                // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«æœŸé–“ãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•é–‹å§‹
                const nextStepData = currentRecipe.steps[currentStep];
                if (nextStepData.duration > 0) {
                    setTimeout(() => {
                        startTimer();
                    }, 100);
                }
            } else {
                showCompletion();
            }
        }

        // å®Œäº†ç”»é¢ã‚’è¡¨ç¤º
        function showCompletion() {
            // ç·æ™‚é–“ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’åœæ­¢ï¼ˆå¿µã®ãŸã‚ï¼‰
            if (totalTimeInterval) {
                clearInterval(totalTimeInterval);
                totalTimeInterval = null;
            }
            
            // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            document.getElementById('resetButton').style.display = 'none';
            
            // ç·æŠ½å‡ºæ™‚é–“ã®ãƒœãƒƒã‚¯ã‚¹ã‚’éè¡¨ç¤º
            const totalTimeBox = document.querySelector('#totalTime').parentElement;
            if (totalTimeBox) {
                totalTimeBox.style.display = 'none';
            }
            
            document.getElementById('timerStepTitle').textContent = 'å®Œæˆï¼';
            document.getElementById('timerStepInstruction').textContent = '';
            
            // å®Œæˆç”»é¢ã®è¡¨ç¤ºï¼ˆç·æŠ½å‡ºæ™‚é–“ãªã—ï¼‰
            let completionHTML = '';
            if (currentRecipe.extraWater > 0) {
                completionHTML = 
                    '<div class="completion-screen">' +
                    '<div style="color: var(--accent-color); font-size: 22px; font-weight: 600; margin-bottom: 20px;">ãŠæ¹¯' + currentRecipe.extraWater + 'gè¿½åŠ ã§å®Œæˆï¼</div>' +
                    '<div class="completion-icon" style="font-size: 70px;">â˜•</div>' +
                    '<div style="color: var(--accent-color); font-size: 24px; font-weight: 600; margin-top: 10px; white-space: nowrap;">Enjoy your coffee time!</div>' +
                    '</div>';
            } else {
                completionHTML = 
                    '<div class="completion-screen">' +
                    '<div class="completion-icon" style="font-size: 70px;">â˜•</div>' +
                    '<div style="color: var(--accent-color); font-size: 24px; font-weight: 600; margin-top: 10px; white-space: nowrap;">Enjoy your coffee time!</div>' +
                    '</div>';
            }
            
            document.getElementById('timerDisplay').innerHTML = completionHTML;
            document.getElementById('timerControls').innerHTML = 
                '<button class="timer-button" onclick="exitTimer()" style="margin-top: 10px;">é–‰ã˜ã‚‹</button>';
            document.getElementById('nextStepInfo').style.display = 'none';
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªãƒ³ã‚°ã‚’éè¡¨ç¤º
            const progressRingWrapper = document.querySelector('.progress-ring-wrapper');
            if (progressRingWrapper) {
                progressRingWrapper.style.display = 'none';
            }
        }

        // ãƒ“ãƒ¼ãƒ—éŸ³ã‚’é³´ã‚‰ã™ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ãªéŸ³ï¼‰
        function playBeep() {
            // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
            
            // ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã¯audioè¦ç´ ã‚’ä½¿ç”¨
            if (useAudioElements && beepAudioElement) {
                try {
                    beepAudioElement.currentTime = 0;
                    beepAudioElement.play().catch(e => console.log('Audio play failed:', e));
                } catch (e) {
                    console.log('Beep failed:', e);
                }
                return;
            }
            
            // ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¢ãƒ¼ãƒ‰ã§ã¯Web Audio APIã‚’ä½¿ç”¨
            if (audioContext) {
                // AudioContextãŒsuspendedã®å ´åˆã¯resume
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                try {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    // é«˜ã‚ã®ã€Œãƒ”ãƒƒã€ã¨ã„ã†éŸ³
                    oscillator.frequency.value = 1000;
                    oscillator.type = 'sine';
                    
                    // éŸ³é‡ã®è¨­å®š
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                } catch (e) {
                    console.log('Beep failed:', e);
                }
            }
        }

        // å®Œäº†éŸ³ã‚’é³´ã‚‰ã™ï¼ˆ3éŸ³ã®ãƒ¡ãƒ­ãƒ‡ã‚£ï¼‰
        function playCompletionSound() {
            // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ - 3å›ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100, 50, 100]);
            }
            
            // ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã¯audioè¦ç´ ã‚’ä½¿ç”¨
            if (useAudioElements && completionAudioElement) {
                try {
                    completionAudioElement.currentTime = 0;
                    completionAudioElement.play().catch(e => console.log('Audio play failed:', e));
                } catch (e) {
                    console.log('Completion sound failed:', e);
                }
                return;
            }
            
            // ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¢ãƒ¼ãƒ‰ã§ã¯Web Audio APIã‚’ä½¿ç”¨
            if (audioContext) {
                // AudioContextãŒsuspendedã®å ´åˆã¯resume
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                try {
                    const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
                    notes.forEach((freq, index) => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.value = freq;
                        oscillator.type = 'sine';
                        
                        const startTime = audioContext.currentTime + (index * 0.15);
                        gainNode.gain.setValueAtTime(0.2, startTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.2);
                        
                        oscillator.start(startTime);
                        oscillator.stop(startTime + 0.2);
                    });
                } catch (e) {
                    console.log('Completion sound failed:', e);
                }
            }
        }
    </script>
</body>
</html>
